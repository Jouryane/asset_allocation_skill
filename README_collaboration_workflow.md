# 资产配置技能协作流程说明

## 概述

本文档说明了Asset Allocation basic和Aggressive Asset Allocation strategy两个技能之间的协作流程，确保智能体能够正确识别用户需求并按照正确的顺序执行相应的技能。

## 技能定位

### Asset Allocation basic（战略层）
- **定位**：资产配置思想阐述和宏观框架设计
- **输出**：宏观的资产配置框架
- **关键词**：
  - "资产配置思路"
  - "阐述资产配置思想合理性"
  - "我应该如何使用你这套资产配置思路"
  - "设计一个资产配置框架"
  - "帮我设计资产配置"
  - "帮我做资产配置"
  - "设计资产配置框架"
  - "资产配置框架"
  - "配置框架"

### Aggressive Asset Allocation strategy（战术层）
- **定位**：具体选品和执行策略
- **输出**：具体的选品方案和仓位配置建议
- **关键词**：
  - "配置战术"
  - "帮我选品"
  - "买什么"
  - "具体策略"
  - "执行策略"
  - "选品"
  - "战术"

## 协作流程

### 场景1：用户同时要求"框架"和"策略"

**示例用户输入：**
"我是一位40岁的男性、目前收入在年55万人民币，有丰富的投资经验，主要是进行基金股票投资，已婚，没有任何负债，目前我的资金大约是700万人民币，每月开支在20000人民币左右。请你帮我设计一个资产配置框架以及执行的具体策略。"

**执行流程：**

```
用户输入
    ↓
识别到"框架"和"策略"关键词
    ↓
【步骤1】调用Asset Allocation basic
    ├─ 解析用户画像
    ├─ 输出宏观的资产配置框架
    ├─ 计算进取系数和各类资产的配置比例
    └─ 提供风险管理、流动性管理、收益率管理、保障杠杆管理的评估
    ↓
【步骤2】自动调用Aggressive Asset Allocation strategy
    ├─ 接收Asset Allocation basic输出的用户画像和进取系数
    ├─ 自动使用智能选品路由器选择SW_LV1或SW_LV2
    ├─ 输出具体的选品方案和仓位配置建议
    └─ 生成可视化图表（可选）
    ↓
输出完整结果
```

**Agent回复示例：**

```
【资产配置框架】

基于您的画像，我为您设计了以下资产配置框架：

1. 用户画像分析
   - 年龄：40岁 → 职业生涯稳健期
   - 年收入：55万元
   - 总资金：700万元
   - 月支出：2万元
   - 投资经验：丰富
   - 风险偏好：激进

2. 资产配置框架
   - 活钱管理：42万元（6%）
   - 稳健投资：175万元（25%）
   - 进取投资：455万元（65%）
   - 保障类资产：28万元（4%）

3. 进取系数：0.65（职业生涯稳健期 + 风险偏好高）

4. 风险管理评估
   - 最大可承受回撤率：15%
   - 组合实际历史最大回撤率：12% ✅

5. 流动性管理评估
   - 三个月确定性资金需求：6万元
   - 流动性资产配置：42万元
   - 流动性匹配率：700% ✅

6. 收益率管理评估
   - 无风险利率（十年期国债）：2.5%
   - 预期年化收益率：8-12%

7. 保障杠杆管理评估
   - 保障杠杆率：50倍
   - 投资杠杆率：0倍

---

【具体执行策略】

基于您的画像，我已经为您设计了资产配置框架。接下来我将为您生成具体的选品和执行策略。

【智能选品路由器决策结果】

选中选品器：SW_LV2
综合得分：93.5/100

决策原因：
选择申万二级行业指数（SW_LV2）
主要考虑因素：资金规模、风险偏好
- 资金规模700万元，适合二级行业分散投资
- 风险等级4级，二级行业机会更多
- 投资经验丰富，二级行业需要更强的分析能力

【选品结果】

选中的行业指数：
1. 新能源汽车 (801094)
   - 估值分位：15.3%
   - 当前PE：25.6
   - 综合得分：85.7
   - 建议仓位：30%

2. 光伏设备 (801732)
   - 估值分位：18.5%
   - 当前PE：28.3
   - 综合得分：82.4
   - 建议仓位：25%

3. 锂电池 (801735)
   - 估值分位：22.1%
   - 当前PE：32.1
   - 综合得分：78.9
   - 建议仓位：20%

4. 半导体 (801081)
   - 估值分位：28.7%
   - 当前PE：45.2
   - 综合得分：72.3
   - 建议仓位：15%

5. 医疗服务 (801156)
   - 估值分位：32.4%
   - 当前PE：38.7
   - 综合得分：68.5
   - 建议仓位：10%

【仓位配置建议】

- 总资金：700万元
- 进取类投资资金：455万元（65%）
- 建议仓位：70%（基于市场估值）
- 实际投资金额：318.5万元
- 闲置资金：136.5万元（可放入货币基金）

【可视化图表】

已生成以下可视化图表：
- 新能源汽车 PE历史趋势图
- 光伏设备 PE历史趋势图
- 锂电池 PE历史趋势图
- 半导体 PE历史趋势图
- 医疗服务 PE历史趋势图
```

### 场景2：用户只要求"框架"

**示例用户输入：**
"我是一位40岁的男性、目前收入在年55万人民币，有丰富的投资经验，主要是进行基金股票投资，已婚，没有任何负债，目前我的资金大约是700万人民币，每月开支在20000人民币左右。请你帮我设计一个资产配置框架。"

**执行流程：**

```
用户输入
    ↓
识别到"框架"关键词
    ↓
【步骤1】调用Asset Allocation basic
    ├─ 解析用户画像
    ├─ 输出宏观的资产配置框架
    ├─ 计算进取系数和各类资产的配置比例
    └─ 提供风险管理、流动性管理、收益率管理、保障杠杆管理的评估
    ↓
【步骤2】询问用户是否需要具体策略
    ↓
等待用户确认
```

**Agent回复示例：**

```
【资产配置框架】

基于您的画像，我为您设计了以下资产配置框架：

[... 同上 ...]

---

您是否需要我为您提供具体的选品和执行策略？
```

### 场景3：用户只要求"策略"或"选品"

**示例用户输入：**
"我是一位40岁的男性、目前收入在年55万人民币，有丰富的投资经验，主要是进行基金股票投资，已婚，没有任何负债，目前我的资金大约是700万人民币，每月开支在20000人民币左右。请帮我选品。"

**执行流程：**

```
用户输入
    ↓
识别到"选品"关键词
    ↓
【步骤1】直接调用Aggressive Asset Allocation strategy
    ├─ 解析用户画像
    ├─ 自动使用智能选品路由器选择SW_LV1或SW_LV2
    ├─ 输出具体的选品方案和仓位配置建议
    └─ 生成可视化图表（可选）
    ↓
输出选品结果
```

**Agent回复示例：**

```
【智能选品路由器决策结果】

选中选品器：SW_LV2
综合得分：93.5/100

[... 同上 ...]
```

## 智能选品路由器的使用

### 自动触发条件

1. **用户画像触发**
   - 当用户提供完整的用户画像时，智能体自动触发选品路由

2. **市场状态变化**
   - 当市场状态发生显著变化时，智能体重新评估选品器选择

3. **用户画像更新**
   - 当用户画像发生显著变化时，智能体重新评估选品器选择

4. **定期重新评估**
   - 智能体定期（如每月）重新评估选品器选择

### 执行流程

1. 调用intelligent_selector_router.intelligent_select()函数
2. 根据用户画像和市场状态计算SW_LV1和SW_LV2的得分
3. 选择得分更高的选品器
4. 输出详细的决策原因和评分对比
5. 自动运行相应的选品程序（etf_selector.py或sw_lv2_selector.py）

### 输出格式要求

在输出选品结果时，必须包含：

1. **智能选品路由器的决策结果**
   - 选中的选品器（SW_LV1或SW_LV2）
   - 综合得分
   - 决策原因
   - 详细评分对比

2. **选品结果**
   - 选中的行业指数列表
   - 每个指数的估值分位、当前PE、综合得分
   - 建议的仓位配置

3. **可视化图表**
   - PE历史趋势图
   - 换手率变化趋势图
   - 价格相对位置图

## 关键注意事项

1. **先框架后战术**
   - 必须先输出宏观的资产配置框架，再提供具体的选品和执行策略

2. **自动触发**
   - 当用户同时要求"框架"和"策略"时，应该自动执行完整的协作流程，不需要用户再次确认

3. **透明决策**
   - 在调用Aggressive Asset Allocation strategy时，应该说明使用了智能选品路由器，并解释选择SW_LV1或SW_LV2的原因

4. **配置提醒**
   - 在调用Aggressive Asset Allocation strategy前，提醒用户确保已配置config.yaml和dingding.py文件

5. **关键词识别**
   - 正确识别用户输入中的关键词，判断应该调用哪个技能
   - 当同时出现"框架"和"策略"关键词时，自动执行完整的协作流程

## 配置文件要求

在使用Aggressive Asset Allocation strategy前，用户需要配置以下文件：

### config.yaml
```yaml
# 进取系数矩阵
appropriateness_matrix:
  职业生涯起步: {低: 0.15, 中: 0.35, 高: 0.65}
  职业生涯稳健期: {低: 0.25, 中: 0.5, 高: 0.8}
  职业生涯中后期: {低: 0.1, 中: 0.25, 高: 0.6}

# 钉钉机器人配置
MY_ACCESS_TOKEN: "your_access_token"
MY_SECRET: "your_secret"
```

### dingding.py
```python
# 钉钉机器人配置
MY_ACCESS_TOKEN = "your_access_token"
MY_SECRET = "your_secret"
```

## 版本历史

- v1.0 (2025-02-22): 初始版本
  - 定义Asset Allocation basic和Aggressive Asset Allocation strategy的协作流程
  - 明确关键词识别规则
  - 说明智能选品路由器的使用方法
