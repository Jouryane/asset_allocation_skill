# 用户画像解析模块

## 概述

用户画像解析模块（user_profile_parser.py）是一个将非结构化/半结构化的用户输入转换为标准化结构化字段的工具，旨在避免大模型解析偏差，为资产配置系统提供可靠的用户画像数据。

## 核心功能

### 1. 结构化字段提取

支持从自然语言文本中提取以下结构化字段：

#### 基础属性
- **年龄** (age): 用户年龄，单位：岁
- **风险承受能力** (risk_level): 风险等级（1-5级）
  - 1: 非常保守
  - 2: 保守
  - 3: 稳健
  - 4: 激进
  - 5: 非常激进
- **职业生涯阶段** (career_stage): 职业阶段
  - 职业生涯起步
  - 职业生涯稳健期
  - 职业生涯中后期
- **投资经验** (investment_experience): 投资经验水平
  - 丰富、一般、匮乏、较少、较多、无
- **婚姻状态** (marital_status): 婚姻状态
  - 已婚、单身、离异

#### 财务属性
- **年收入** (annual_income): 年收入，单位：万元
- **月支出** (monthly_expense): 月支出，单位：万元
- **可投资金额** (total_capital): 可投资金额，单位：万元
- **负债状态** (debt_status): 负债状态字典
  - has_debt: 是否有负债
  - debt_amount: 负债金额（万元）

### 2. 智能单位转换

自动识别并转换不同的财务单位：
- "万" → 直接使用
- "元"（数值≥1000）→ 除以10000转换为万元
- "元"（数值<1000）→ 直接使用（单位：万元）
- "k" / "K" → 除以10000转换为万元

### 3. 数据验证

- **必填字段验证**: age、annual_income、total_capital
- **合理性检查**: 
  - 年龄范围：18-80岁
  - 资金与收入关系：总资金不应超过年收入的100倍
- **缺失字段提示**: 列出缺失的必填字段
- **建议提示**: 提供补充信息的建议

### 4. 参数转换

将用户画像转换为strategy.py所需的参数格式：
- 财务字段从万元转换为元
- 保持数值类型的一致性

## 文件结构

```
asset_allocation/
├── user_profile_parser.py          # 用户画像解析核心模块
├── user_profile_integration.py      # 用户画像与资产配置集成示例
├── user_profile_fields.md           # 结构化字段详细说明文档
└── README_user_profile.md           # 本文档
```

## 使用方法

### 方式1：直接使用解析器类

```python
from user_profile_parser import UserProfileParser

# 创建解析器实例
parser = UserProfileParser()

# 解析用户文本
user_text = "我是一位34岁的男性、目前收入在年30万人民币，投资经验比较匮乏，主要是进行存款，但现在想要学习一些股票基金投资，已婚，没有任何负债，目前我的资金大约是100万人民币，每月开支在10000人民币左右。"

profile = parser.parse_text(user_text)

# 验证画像
validation = parser.validate_profile(profile)

# 格式化输出
print(parser.format_profile(profile))

# 转换为strategy.py参数
strategy_params = parser.export_to_strategy_params(profile)
```

### 方式2：使用便捷函数

```python
from user_profile_parser import parse_user_profile

# 解析用户文本
user_text = "35岁，年收入50万，月支出8000元，可投资金额100万，风险等级3（稳健型）"

profile, validation = parse_user_profile(user_text)

# 检查验证结果
if validation['is_valid']:
    print("用户画像验证通过")
else:
    print("缺失字段：", validation['missing_fields'])
```

### 方式3：使用集成示例

```python
from user_profile_integration import analyze_user_profile

# 分析用户画像并生成资产配置建议
user_text = "我是一位34岁的男性、目前收入在年30万人民币，投资经验比较匮乏，主要是进行存款，但现在想要学习一些股票基金投资，已婚，没有任何负债，目前我的资金大约是100万人民币，每月开支在10000人民币左右。"

result = analyze_user_profile(user_text)
```

## 支持的输入格式

### 年龄
- "34岁"
- "年龄：34"
- "我今年34岁"
- "34周岁"
- "34 years old"

### 年收入
- "年收入：30万"
- "年薪30万"
- "收入30万"
- "收入在年30万人民币"
- "目前收入在年30万"

### 月支出
- "月支出：1万"
- "每月开支1万"
- "月开支在10000人民币"
- "月开支在10000元"

### 可投资金额
- "资金100万"
- "总资金100万"
- "可投资金额100万"
- "可支配金融资产100万"
- "大约100万"
- "资金大约是100万人民币"
- "目前我的资金大约是100万"

### 风险偏好
- "风险偏好：稳健"
- "风险承受能力：3级"
- "风险等级3"
- "我是稳健型"

### 投资经验
- "投资经验：匮乏"
- "投资经验匮乏"
- "没有投资经验"
- "投资经验较少"

### 职业生涯阶段
- "职业生涯阶段：稳健"
- "工作年限5年"

### 婚姻状态
- "已婚"
- "单身"
- "离异"

### 负债状态
- "有负债"
- "无负债"
- "没有任何负债"
- "负债50万"

## 输出示例

### 结构化输出

```python
{
    "age": 34.0,
    "annual_income": 30.0,
    "monthly_expense": 1.0,
    "total_capital": 100.0,
    "risk_preference": None,
    "risk_level": None,
    "investment_experience": "匮乏",
    "career_stage": None,
    "marital_status": "已婚",
    "debt_status": {"has_debt": False, "debt_amount": 0},
    "work_years": None
}
```

### 格式化文本输出

```
================================================================================
用户画像结构化解析结果
================================================================================

【基础属性】
  年龄：34.0岁
  婚姻状态：已婚

【财务属性】
  年收入：30.00万元
  月支出：1.00万元
  可投资金额：100.00万元
  负债状态：无负债

================================================================================
```

### 验证结果输出

```python
{
    'is_valid': True,
    'missing_fields': [],
    'warnings': [],
    'suggestions': ['未明确风险偏好，建议根据年龄和经验设定']
}
```

## 与Asset Allocation basic的衔接

用户画像解析模块为Asset Allocation basic提供以下支持：

### 1. 风险管理
- 根据age、risk_level、career_stage计算进取系数
- 提供风险承受能力评估
- 生成风险管理建议

### 2. 流动性管理
- 根据monthly_expense计算流动性匹配率
- 计算流动性需求（3个月/6个月支出）
- 生成流动性配置建议

### 3. 收益率管理
- 根据annual_income和历史收益数据计算实际收益率
- 与无风险利率（十年期国债利率）对比
- 提供收益率优化建议

### 4. 保障杠杆管理
- 根据marital_status、debt_status计算保障杠杆率
- 评估保障能力和抗风险能力
- 提供保障配置建议

## 进取系数建议表

根据Asset Allocation basic.md中的资产配置思想：

| 职业生涯阶段 | 风险偏好低 | 风险偏好中 | 风险偏好高 |
|-------------|-----------|-----------|-----------|
| 职业生涯起步 | 0.15 | 0.35 | 0.65 |
| 职业生涯稳健期 | 0.25 | 0.50 | 0.80 |
| 职业生涯中后期 | 0.10 | 0.25 | 0.60 |

**说明：**
- 进取系数是指为追求目标配置方案，用户选取进取类资产的投资比例
- 金融知识、投资经验相对匮乏的用户优先关注风险管理项目，选择相对低的进取系数
- 每月盈余状态不佳的用户优先关注流动性管理项目

## 资产配置示例

基于用户画像生成的资产配置方案：

```
总资金：100.00万元

资产配置方案：
┌─────────────────────────────────────────────────────────┐
│ 活钱管理（流动性资产）：    3.00万元（  3.0%） │
├─────────────────────────────────────────────────────────┤
│ 稳健投资（稳健类资产）：   63.05万元（ 63.1%） │
├─────────────────────────────────────────────────────────┤
│ 进取投资（进取类资产）：   33.95万元（ 33.9%） │
└─────────────────────────────────────────────────────────┘
```

## 预警机制

### 风险管理预警
- ⚠️ 进取类资产占比 > 用户进取系数

### 流动性管理预警
- ⚠️ 流动性资金 < 三个月月支出

### 收益率管理预警
- ⚠️ 年化收益 < 十年期国债利率

## 注意事项

1. **适当性原则**: 禁止在用户倾向保守时提出激进的建议
2. **合规性**: Asset Allocation basic仅作为阐述资产配置逻辑的基础，不包含具体的资产配置方案、禁止涉及任何具体产品的推荐
3. **数据完整性**: 建议用户提供完整的必填字段信息以获得更准确的配置建议
4. **单位一致性**: 模块会自动处理不同的财务单位，但建议用户使用统一的单位格式

## 测试用例

### 测试用例1：完整用户画像
```
我是一位34岁的男性、目前收入在年30万人民币，投资经验比较匮乏，主要是进行存款，但现在想要学习一些股票基金投资，已婚，没有任何负债，目前我的资金大约是100万人民币，每月开支在10000人民币左右。
```

### 测试用例2：简洁格式
```
35岁，年收入50万，月支出8000元，可投资金额100万，风险等级3（稳健型）
```

### 测试用例3：详细信息
```
年龄40岁，年薪80万，总资金200万，月支出1.5万，已婚有负债50万，投资经验一般，风险偏好激进
```

### 测试用例4：工作年限推断
```
我今年28岁，工作3年，年收入35万，资金80万，无负债，投资经验较少，风险承受能力2级（保守）
```

## 运行测试

```bash
# 运行用户画像解析器测试
python user_profile_parser.py

# 运行用户画像与资产配置集成示例
python user_profile_integration.py
```

## 扩展功能

### 自定义正则表达式模式

可以通过修改`UserProfileParser`类中的`patterns`字典来添加或修改字段解析规则：

```python
self.patterns = {
    'age': [
        r'(\d+)\s*岁',
        # 添加更多模式...
    ],
    # 添加更多字段...
}
```

### 自定义验证规则

可以通过重写`validate_profile`方法来自定义验证逻辑：

```python
def validate_profile(self, profile: Dict[str, any]) -> Dict[str, any]:
    # 自定义验证逻辑
    pass
```

## 常见问题

### Q1: 为什么某些字段没有被正确提取？

A: 请检查输入文本是否符合支持的格式，或者考虑添加更多的正则表达式模式来支持更多格式。

### Q2: 如何处理缺失的必填字段？

A: 可以通过validation['missing_fields']获取缺失字段列表，并提示用户补充信息。

### Q3: 如何自定义进取系数的计算逻辑？

A: 可以修改`user_profile_integration.py`中的`calculate_aggressiveness`函数来实现自定义逻辑。

### Q4: 如何与strategy.py集成？

A: 使用`export_to_strategy_params`方法将用户画像转换为strategy.py所需的参数格式。

## 版本历史

- v1.0 (2026-02-22): 初始版本，支持基础属性和财务属性的结构化解析
  - 支持年龄、年收入、月支出、总资金等核心字段
  - 智能单位转换
  - 数据验证和合理性检查
  - 与Asset Allocation basic和strategy.py的集成

## 相关文档

- [Asset Allocation basic.md](Asset Allocation basic.md) - 资产配置基础文档
- [user_profile_fields.md](user_profile_fields.md) - 结构化字段详细说明
- [strategy.py](strategy.py) - 策略执行模块

## 许可证

本模块为资产配置系统的一部分，遵循整体项目的许可证协议。

## 联系方式

如有问题或建议，请联系项目维护者。
